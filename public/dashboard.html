<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Dashboard - Master Body Shop</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-100 text-gray-900 min-h-screen flex flex-col">
  <!-- Navbar -->
  <nav class="bg-blue-600 text-white p-4 shadow-md flex justify-between">
    <h1 class="text-xl font-bold">Master Body Shop</h1>
    <div>
      <a href="index.html" class="px-3 hover:underline">Home</a>
      <a href="dashboard.html" class="px-3 hover:underline">Dashboard</a>
    </div>
  </nav>

  <!-- Search input -->
  <div class="p-6 flex flex-col md:flex-row gap-4 items-center">
    <input
      type="text"
      id="searchInput"
      placeholder="Search by customer, VIN..."
      class="border px-4 py-2 rounded w-full md:w-1/3"
    />
    <select id="statusFilter" class="border px-4 py-2 rounded w-full md:w-1/6">
      <option value="">All Statuses</option>
      <option>Received</option>
      <option>In Progress</option>
      <option>Waiting on Parts</option>
      <option>Completed</option>
    </select>
    <input id="makeFilter" type="text" placeholder="Make" class="border px-4 py-2 rounded w-full md:w-1/6" />
    <input id="modelFilter" type="text" placeholder="Model" class="border px-4 py-2 rounded w-full md:w-1/6" />
    <label class="flex items-center gap-2"><input type="checkbox" id="readyFilter"> Ready</label>
    <label class="flex items-center gap-2"><input type="checkbox" id="paymentFilter"> Paid</label>
    <label class="flex items-center gap-2"><input type="checkbox" id="partsFilter"> Parts Ordered</label>
  </div>

  <!-- Photo Modal -->
  <div id="photoModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg max-w-4xl max-h-full overflow-hidden">
      <div class="flex justify-between items-center p-4 border-b">
        <h3 class="text-lg font-bold">Car Photos</h3>
        <button id="closeModal" class="text-gray-500 hover:text-gray-700">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div id="modalContent" class="p-4 max-h-96 overflow-y-auto">
        <!-- Photos will be inserted here -->
      </div>
    </div>
  </div>

  <!-- Cards Grid -->
  <main id="carsGrid" class="p-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 flex-grow">
    <!-- Cars will be inserted here -->
  </main>

  <!-- Footer -->
  <footer class="bg-gray-800 text-white p-4 text-center">
    Master Body Shop Â© 2025
  </footer>

  <script>
    let carsData = [];

    async function fetchCars() {
      const res = await fetch("/dashboard");
      carsData = await res.json();
      renderCards(carsData);
    }

    async function fetchCarPhotos(carId) {
      try {
        const res = await fetch(`/car/${carId}`);
        const carData = await res.json();
        return carData.photos || [];
      } catch (error) {
        console.error('Error fetching photos:', error);
        return [];
      }
    }

    function renderCards(cars) {
      const grid = document.getElementById("carsGrid");
      grid.innerHTML = "";

      if (cars.length === 0) {
        grid.innerHTML = '<div class="col-span-3 text-center py-10 text-gray-500">No cars found</div>';
        return;
      }

      cars.forEach(car => {
        const card = document.createElement("div");
        card.className = "bg-white rounded-2xl shadow-lg p-5 flex flex-col gap-4 hover:shadow-2xl transition";

        // Photo section at top
        const photoSection = document.createElement("div");
        photoSection.className = "relative";

        // Main photo display
        const mainPhoto = document.createElement("div");
        mainPhoto.className = "w-full h-48 bg-gray-200 rounded-lg flex items-center justify-center overflow-hidden cursor-pointer relative";
        mainPhoto.setAttribute('data-car-id', car.Id);

        // Show preview image if available
        if (car.PhotoCount > 0) {
          // Use correct backend route for preview image
          mainPhoto.innerHTML = `
            <img src="/photo/car/${car.Id}" alt="Car Photo" class="w-full h-full object-cover" onerror="this.style.display='none';this.parentNode.querySelector('.fallback-photo').style.display='flex';">
            <div class="fallback-photo text-center text-gray-500 absolute inset-0 items-center justify-center hidden flex-col">
              <i class="fas fa-camera text-4xl mb-2"></i>
              <p>No preview available</p>
            </div>
            <div class="absolute bottom-2 right-2 bg-black bg-opacity-50 text-white text-xs px-2 py-1 rounded">
              ${car.PhotoCount} photo${car.PhotoCount > 1 ? 's' : ''}
            </div>
          `;
        } else {
          mainPhoto.innerHTML = `
            <div class="text-center text-gray-500">
              <i class="fas fa-camera text-4xl mb-2"></i>
              <p>No photos</p>
            </div>
          `;
        }

        photoSection.appendChild(mainPhoto);
        
        // Car info section
        const info = document.createElement("div");
        info.className = "flex-1";

        info.innerHTML = `
          <h2 class="text-lg font-bold mb-2">${car.Year || ''} ${car.Make || ''} ${car.Model || ''}</h2>
          <p><span class="font-semibold">Customer:</span> ${car.Customer || ''}</p>
          <p><span class="font-semibold">VIN:</span> ${car.VIN || 'N/A'}</p>
          <p class="flex items-center"><span class="font-semibold">Color:</span> 
            ${car.Color ? `
              <span class="ml-1 inline-flex items-center">
                <span class="inline-block w-4 h-4 rounded-full border mr-1" style="background:${car.Color.toLowerCase()}"></span>
                ${car.Color}
              </span>
            ` : 'N/A'}
          </p>
          <p><span class="font-semibold">Arrival:</span> ${new Date(car.ArrivalDate).toLocaleDateString()}</p>
          
          <div class="mt-3 grid grid-cols-2 gap-2">
            <div>
              <label class="font-semibold block text-sm">Status</label>
              <select class="workStatus border rounded px-2 py-1 w-full text-sm">
                <option ${car.WorkStatus === "Received" ? "selected" : ""}>Received</option>
                <option ${car.WorkStatus === "In Progress" ? "selected" : ""}>In Progress</option>
                <option ${car.WorkStatus === "Waiting on Parts" ? "selected" : ""}>Waiting on Parts</option>
                <option ${car.WorkStatus === "Completed" ? "selected" : ""}>Completed</option>
              </select>
            </div>
            <div class="mt-2">
              <label class="font-semibold block text-sm">Customer Phone</label>
              <input type="tel" value="${car.CustomerPhone || ''}" class="customerPhone border px-2 py-1 rounded w-full text-sm" placeholder="(555) 123-4567">
            </div>
            <div>
              <label class="font-semibold block text-sm">Ready for Work</label>
              <select class="readyForWork border rounded px-2 py-1 w-full text-sm">
                <option ${car.ReadyForWork === "Yes" ? "selected" : ""}>Yes</option>
                <option ${car.ReadyForWork === "No" ? "selected" : ""}>No</option>
              </select>
            </div>
            <div class="col-span-2">
              <label class="font-semibold block text-sm">Parts Ordered</label>
              <select class="partsOrdered border rounded px-2 py-1 w-full text-sm">
                <option ${car.PartsOrdered === "Yes" ? "selected" : ""}>Yes</option>
                <option ${car.PartsOrdered === "No" ? "selected" : ""}>No</option>
                <option ${car.PartsOrdered === "Customer Provided" ? "selected" : ""}>Customer Provided</option>
              </select>
            </div>
          </div>
          
          <div class="mt-2">
            <label class="font-semibold block text-sm">Notes</label>
            <input type="text" value="${car.Notes || ''}" class="notes border px-2 py-1 rounded w-full text-sm" placeholder="Add notes...">
          </div>
          
          <div class="mt-2 flex items-center gap-2">
            <input type="checkbox" ${car.CustomerPayment ? "checked" : ""} class="customerPayment">
            <label class="font-semibold text-sm">Payment Received</label>
          </div>

          <form class="mt-2 flex gap-2 items-center photoUploadForm" enctype="multipart/form-data">
            <input type="file" accept="image/*" class="photoInput border px-2 py-1 rounded text-sm" style="max-width: 180px;" />
            <button type="submit" class="bg-purple-500 text-white px-3 py-1 rounded text-sm">Add Photo</button>
            <span class="uploadStatus text-xs text-gray-500"></span>
          </form>

          <div class="mt-4 flex gap-2">
            <button class="updateBtn bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 flex-1">Update</button>
            <button class="viewPhotosBtn bg-green-500 text-white px-3 py-2 rounded-lg hover:bg-green-600 ${car.PhotoCount === 0 ? 'hidden' : ''}" data-car-id="${car.Id}">
              <i class="fas fa-images"></i>
            </button>
          </div>
        `;

        // Assemble card
        card.appendChild(photoSection);
        card.appendChild(info);
        grid.appendChild(card);

        // Add event listeners
        // Photo upload functionality
        const photoForm = info.querySelector('.photoUploadForm');
        const photoInput = info.querySelector('.photoInput');
        const uploadStatus = info.querySelector('.uploadStatus');
        if (photoForm && photoInput) {
          photoForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!photoInput.files.length) {
              uploadStatus.textContent = 'Select a photo first.';
              return;
            }
            const file = photoInput.files[0];
            const formData = new FormData();
            formData.append('photo', file);
            uploadStatus.textContent = 'Uploading...';
            try {
              const res = await fetch(`/upload-photo/${car.Id}`, {
                method: 'POST',
                body: formData
              });
              const result = await res.text();
              uploadStatus.textContent = result;
              fetchCars(); // refresh
            } catch (err) {
              uploadStatus.textContent = 'Upload failed.';
            }
          });
        }
        const updateBtn = info.querySelector(".updateBtn");
        updateBtn.addEventListener("click", async () => {
         // In your dashboard script, update the updateBtn event listener:
const updatedData = {
  workStatus: info.querySelector(".workStatus").value,
  readyForWork: info.querySelector(".readyForWork").value,
  partsOrdered: info.querySelector(".partsOrdered").value,
  notes: info.querySelector(".notes").value,
  customerPayment: info.querySelector(".customerPayment").checked,
  customerPhone: info.querySelector(".customerPhone").value // Make sure this exists
};

          const res = await fetch(`/update-car/${car.Id}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(updatedData)
          });

          const result = await res.text();
          alert(result);
          fetchCars(); // refresh
        });

        // Photo viewing functionality
        const viewPhotosBtn = info.querySelector(".viewPhotosBtn");
        const mainPhotoDiv = photoSection.querySelector("div");
        
        const showPhotos = async (carId) => {
          const photos = await fetchCarPhotos(carId);
          if (photos.length === 0) {
            alert('No photos found for this car');
            return;
          }
          
          const modal = document.getElementById('photoModal');
          const modalContent = document.getElementById('modalContent');
          
          modalContent.innerHTML = `
            <div class="text-center mb-4">
              <h4 class="font-bold">${car.Year || ''} ${car.Make || ''} ${car.Model || ''} - ${car.Customer || ''}</h4>
              <p class="text-sm text-gray-600">${photos.length} photo${photos.length > 1 ? 's' : ''}</p>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              ${photos.map(photo => `
                <div class="border rounded-lg overflow-hidden">
                  <img src="/photo/${photo.Id}" alt="Car photo" class="w-full h-48 object-cover">
                  <div class="p-2 text-xs text-gray-600">
                    Taken: ${new Date(photo.CreatedAt).toLocaleString()}
                  </div>
                </div>
              `).join('')}
            </div>
          `;
          
          modal.classList.remove('hidden');
        };
        
        if (viewPhotosBtn) {
          viewPhotosBtn.addEventListener('click', () => showPhotos(car.Id));
        }
        
        if (mainPhotoDiv) {
          mainPhotoDiv.addEventListener('click', () => {
            if (car.PhotoCount > 0) showPhotos(car.Id);
          });
        }
      });
    }

    // Close modal functionality
    document.getElementById('closeModal').addEventListener('click', () => {
      document.getElementById('photoModal').classList.add('hidden');
    });

    // Close modal when clicking outside
    document.getElementById('photoModal').addEventListener('click', (e) => {
      if (e.target.id === 'photoModal') {
        document.getElementById('photoModal').classList.add('hidden');
      }
    });

    // Search/filter
    function filterCars() {
      const query = document.getElementById("searchInput").value.toLowerCase();
      const status = document.getElementById("statusFilter").value;
      const make = document.getElementById("makeFilter").value.toLowerCase();
      const model = document.getElementById("modelFilter").value.toLowerCase();
      const ready = document.getElementById("readyFilter").checked;
      const paid = document.getElementById("paymentFilter").checked;
      const parts = document.getElementById("partsFilter").checked;

      let filtered = carsData.filter(car => {
        let match = true;
        if (query) {
          match = match && (
            (car.Customer && car.Customer.toLowerCase().includes(query)) ||
            ((car.Make || '').toLowerCase().includes(query)) ||
            ((car.Model || '').toLowerCase().includes(query)) ||
            ((car.WorkStatus || '').toLowerCase().includes(query)) ||
            ((car.VIN || '').toLowerCase().includes(query))
          );
        }
        if (status) match = match && car.WorkStatus === status;
        if (make) match = match && (car.Make && car.Make.toLowerCase().includes(make));
        if (model) match = match && (car.Model && car.Model.toLowerCase().includes(model));
        if (ready) match = match && car.ReadyForWork === "Yes";
        if (paid) match = match && car.CustomerPayment;
        if (parts) match = match && car.PartsOrdered === "Yes";
        return match;
      });
      renderCards(filtered);
    }

    document.getElementById("searchInput").addEventListener("input", filterCars);
    document.getElementById("statusFilter").addEventListener("change", filterCars);
    document.getElementById("makeFilter").addEventListener("input", filterCars);
    document.getElementById("modelFilter").addEventListener("input", filterCars);
    document.getElementById("readyFilter").addEventListener("change", filterCars);
    document.getElementById("paymentFilter").addEventListener("change", filterCars);
    document.getElementById("partsFilter").addEventListener("change", filterCars);

    // Initial fetch
    fetchCars();
  </script>
</body>
</html>