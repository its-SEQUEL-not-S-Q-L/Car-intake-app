<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Master Body Shop - Car Intake</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Add Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-100 font-sans min-h-screen flex items-center justify-center p-6">

  <!-- Card -->
  <div class="bg-white shadow-2xl rounded-2xl p-8 w-full max-w-4xl space-y-6">

    <!-- Header + Dashboard Link -->
    <div class="flex justify-between items-center border-b pb-4">
      <h1 class="text-3xl font-extrabold text-gray-800">Master Body Shop</h1>
      <a href="/dashboard.html" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700 transition">
        View Dashboard
      </a>
    </div>

    <!-- Intake Form -->
    <form id="intakeForm" class="grid grid-cols-1 md:grid-cols-2 gap-6">
      
      <!-- Customer -->
      <div class="col-span-2">
        <label class="block text-gray-700 font-semibold mb-1">Customer</label>
        <input type="text" name="customer" required
          class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
      </div>

      <!-- Year -->
      <div>
        <label class="block text-gray-700 font-semibold mb-1">Year</label>
        <input type="number" name="year" id="year" required
          class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
      </div>

      <!-- Make -->
      <div>
        <label class="block text-gray-700 font-semibold mb-1">Make</label>
        <input type="text" name="make" id="make" required
          class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
      </div>

      <!-- Model -->
      <div>
        <label class="block text-gray-700 font-semibold mb-1">Model</label>
        <input type="text" name="model" id="model" required
          class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
      </div>

      <!-- Color -->
      <div>
        <label class="block text-gray-700 font-semibold mb-1">Color</label>
        <input type="text" name="color" id="color"
          class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Optional">
      </div>

      <!-- VIN + Scan -->
      <div class="col-span-2">
        <label class="block text-gray-700 font-semibold mb-1">VIN</label>
        <div class="flex gap-2">
          <input type="text" name="vin" id="vin"
            class="flex-1 px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Optional">
          <button type="button" id="decodeVin"
            class="bg-indigo-600 text-white px-4 rounded-lg hover:bg-indigo-700 transition">
            Scan
          </button>
        </div>
      </div>

      <!-- Car Photos Section -->
      <div class="col-span-2 border-t pt-4">
        <label class="block text-gray-700 font-semibold mb-3">Car Photos</label>
        
        <!-- Photo Capture Interface -->
        <div class="space-y-4">
          <!-- Camera Input -->
          <div class="flex flex-col items-center p-4 border-2 border-dashed border-gray-300 rounded-lg">
            <video id="video" class="w-full max-w-md rounded-lg hidden"></video>
            <canvas id="canvas" class="hidden"></canvas>
            
            <div id="cameraControls" class="space-y-3 w-full max-w-md">
              <input type="file" id="fileInput" accept="image/*" capture="camera" class="hidden">
              
              <div class="flex gap-2 justify-center">
                <button type="button" id="startCamera" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">
                  <i class="fas fa-camera mr-2"></i>Start Camera
                </button>
                <button type="button" id="capturePhoto" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition hidden">
                  <i class="fas fa-camera-retro mr-2"></i>Capture Photo
                </button>
                <button type="button" id="uploadPhoto" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition">
                  <i class="fas fa-upload mr-2"></i>Upload Photo
                </button>
              </div>
              
              <button type="button" id="stopCamera" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition hidden">
                <i class="fas fa-stop mr-2"></i>Stop Camera
              </button>
            </div>
          </div>

          <!-- Photo Gallery -->
          <div id="photoGallery" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3 mt-4">
            <!-- Photos will be displayed here -->
          </div>
        </div>
      </div>

      <!-- Arrival Date -->
      <div>
        <label class="block text-gray-700 font-semibold mb-1">Arrival Date</label>
        <input type="date" name="arrivalDate"
          class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" required>
      </div>

      <!-- Parts Ordered -->
      <div>
        <label class="block text-gray-700 font-semibold mb-1">Parts Ordered</label>
        <select name="partsOrdered"
          class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
          <option value="Yes">Yes</option>
          <option value="No">No</option>
          <option value="Customer Provided">Customer Provided</option>
        </select>
      </div>

      <!-- Part Order Date -->
      <div>
        <label class="block text-gray-700 font-semibold mb-1">Part Order Date</label>
        <input type="date" name="partOrderDate"
          class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
      </div>

      <!-- Parts Arrival Date -->
      <div>
        <label class="block text-gray-700 font-semibold mb-1">Parts Arrival Date</label>
        <input type="date" name="partsArrivalDate"
          class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
      </div>

      <!-- Ready for Work -->
      <div>
        <label class="block text-gray-700 font-semibold mb-1">Ready For Work</label>
        <select name="readyForWork"
          class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
          <option value="Yes">Yes</option>
          <option value="No">No</option>
        </select>
      </div>

      <!-- Work Status -->
      <div>
        <label class="block text-gray-700 font-semibold mb-1">Work Status</label>
        <select name="workStatus"
          class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
          <option value="Received">Received</option>
          <option value="In Progress">In Progress</option>
          <option value="Waiting on Parts">Waiting on Parts</option>
          <option value="Completed">Completed</option>
        </select>
      </div>

      <!-- Bay -->
      <div>
        <label class="block text-gray-700 font-semibold mb-1">Bay</label>
        <input type="text" name="bay"
          class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
      </div>

      <!-- Technician -->
      <div>
        <label class="block text-gray-700 font-semibold mb-1">Technician</label>
        <input type="text" name="tech"
          class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
      </div>

      <!-- Date Done -->
      <div>
        <label class="block text-gray-700 font-semibold mb-1">Date Done</label>
        <input type="date" name="dateDone"
          class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
      </div>

      <!-- Submit -->
      <div class="col-span-2">
        <button type="submit"
          class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition">
          Submit
        </button>
      </div>
    </form>
  </div>

  <script>
    // Array to store base64 encoded photos
    let carPhotos = [];

    // Camera elements
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const startCameraBtn = document.getElementById('startCamera');
    const stopCameraBtn = document.getElementById('stopCamera');
    const capturePhotoBtn = document.getElementById('capturePhoto');
    const uploadPhotoBtn = document.getElementById('uploadPhoto');
    const fileInput = document.getElementById('fileInput');
    const photoGallery = document.getElementById('photoGallery');

    // Camera functionality
    let stream = null;

    startCameraBtn.addEventListener('click', async () => {
      try {
        stream = await navigator.mediaDevices.getUserMedia({ 
          video: { facingMode: 'environment' } // Use rear camera by default
        });
        video.srcObject = stream;
        video.classList.remove('hidden');
        video.play();
        
        startCameraBtn.classList.add('hidden');
        capturePhotoBtn.classList.remove('hidden');
        stopCameraBtn.classList.remove('hidden');
      } catch (err) {
        alert('Error accessing camera: ' + err.message);
      }
    });

    stopCameraBtn.addEventListener('click', () => {
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
        video.classList.add('hidden');
        startCameraBtn.classList.remove('hidden');
        capturePhotoBtn.classList.add('hidden');
        stopCameraBtn.classList.add('hidden');
      }
    });

    capturePhotoBtn.addEventListener('click', () => {
      const context = canvas.getContext('2d');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      context.drawImage(video, 0, 0, canvas.width, canvas.height);
      
      // Convert to base64
      const base64Photo = canvas.toDataURL('image/jpeg', 0.8);
      addPhotoToGallery(base64Photo);
    });

    uploadPhotoBtn.addEventListener('click', () => {
      fileInput.click();
    });

    fileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (event) => {
          addPhotoToGallery(event.target.result);
        };
        reader.readAsDataURL(file);
      }
    });

    // Function to add photo to gallery and array
    function addPhotoToGallery(base64Data) {
      const photoId = Date.now();
      carPhotos.push({
        id: photoId,
        data: base64Data,
        timestamp: new Date().toLocaleString()
      });

      const photoElement = document.createElement('div');
      photoElement.className = 'relative group';
      photoElement.innerHTML = `
        <img src="${base64Data}" alt="Car photo" class="w-full h-24 object-cover rounded-lg">
        <button type="button" onclick="removePhoto(${photoId})" 
          class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
          <i class="fas fa-times text-xs"></i>
        </button>
        <div class="text-xs text-gray-500 mt-1 truncate">${new Date().toLocaleTimeString()}</div>
      `;
      photoGallery.appendChild(photoElement);
    }

    // Function to remove photo
    window.removePhoto = function(photoId) {
      carPhotos = carPhotos.filter(photo => photo.id !== photoId);
      document.querySelector(`[onclick="removePhoto(${photoId})"]`).parentElement.remove();
    };

    // VIN decode feature
    document.getElementById("decodeVin").addEventListener("click", async () => {
      const vin = document.getElementById("vin").value.trim();
      if (!vin) return alert("Please enter a VIN to scan.");

      try {
        const response = await fetch(`https://vpic.nhtsa.dot.gov/api/vehicles/decodevinvalues/${vin}?format=json`);
        const data = await response.json();
        if (data.Results && data.Results[0]) {
          const result = data.Results[0];
          document.getElementById("year").value = result.ModelYear || "";
          document.getElementById("make").value = result.Make || "";
          document.getElementById("model").value = result.Model || "";
          document.getElementById("color").value = result.Color || "";
        }
      } catch (error) {
        alert("Error decoding VIN. Please try again.");
      }
    });

    // Form submission
    document.getElementById("intakeForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const formData = Object.fromEntries(new FormData(e.target).entries());
      
      // Add photos to form data
      const submissionData = {
        ...formData,
        photos: carPhotos
      };

      try {
        const response = await fetch("/intake", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(submissionData)
        });

        const result = await response.text();
        alert("Car intake submitted successfully with " + carPhotos.length + " photos!");
        e.target.reset();
        carPhotos = [];
        photoGallery.innerHTML = '';
        
        // Stop camera if running
        if (stream) {
          stream.getTracks().forEach(track => track.stop());
        }
      } catch (error) {
        alert("Error submitting form: " + error.message);
      }
    });

    // Set today's date as default for arrival date
    document.querySelector('input[name="arrivalDate"]').valueAsDate = new Date();
  </script>
</body>
</html>