<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Dashboard - Master Body Shop</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-100 text-gray-900 min-h-screen flex flex-col">
  <!-- Button Group -->
  <div class="w-full flex justify-center pt-8">
    <div class="flex gap-4">
      <a href="/welcome.html" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition flex items-center">
        <i class="fas fa-home mr-2"></i> Home
      </a>
      <a href="/dashboard-inprogress.html" class="bg-yellow-400 text-white font-semibold py-2 px-4 rounded-lg hover:bg-yellow-500 transition flex items-center">
        <i class="fas fa-spinner mr-2"></i> In Progress
      </a>
      <a href="/dashboard-received.html" class="bg-gray-400 text-white font-semibold py-2 px-4 rounded-lg hover:bg-gray-500 transition flex items-center">
        <i class="fas fa-inbox mr-2"></i> Received
      </a>
      <a href="/dashboard-completed.html" class="bg-green-400 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-500 transition flex items-center">
        <i class="fas fa-check-circle mr-2"></i> Completed (Not Paid)
      </a>
      <a href="/dashboard-archived.html" class="bg-gray-700 text-white font-semibold py-2 px-4 rounded-lg hover:bg-gray-800 transition flex items-center">
        <i class="fas fa-archive mr-2"></i> Archived
      </a>
      <a href="/dashboard.html" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700 transition flex items-center">
        <i class="fas fa-tachometer-alt mr-2"></i> All Cars
      </a>
      <a id="adminDashBtn" href="/admin-dashboard.html" style="display:none" class="bg-yellow-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-yellow-700 transition flex items-center">
        <i class="fas fa-user-shield mr-2"></i> Admin Dashboard
      </a>
      <button type="button" id="logoutBtn" class="bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700 transition flex items-center">
        <i class="fas fa-sign-out-alt mr-2"></i> Logout
      </button>
    </div>
  </div>

  <!-- Search input -->
  <div class="p-6 flex flex-col md:flex-row gap-4 items-center">
    <input
      type="text"
      id="searchInput"
      placeholder="Search by customer, VIN..."
      class="border px-4 py-2 rounded w-full md:w-1/3"
    />
    <select id="statusFilter" class="border px-4 py-2 rounded w-full md:w-1/6">
      <option value="">All Statuses</option>
      <option>Received</option>
      <option>In Progress</option>
      <option>Waiting on Parts</option>
      <option>Completed</option>
    </select>
    <input id="makeFilter" type="text" placeholder="Make" class="border px-4 py-2 rounded w-full md:w-1/6" />
    <input id="modelFilter" type="text" placeholder="Model" class="border px-4 py-2 rounded w-full md:w-1/6" />
    <label class="flex items-center gap-2"><input type="checkbox" id="readyFilter"> Ready</label>
    <label class="flex items-center gap-2"><input type="checkbox" id="paymentFilter"> Paid</label>
    <label class="flex items-center gap-2"><input type="checkbox" id="partsFilter"> Parts Ordered</label>
  </div>

  <!-- Photo Modal -->
  <div id="photoModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg max-w-4xl max-h-full overflow-hidden">
      <div class="flex justify-between items-center p-4 border-b">
        <h3 class="text-lg font-bold">Car Photos</h3>
        <button id="closeModal" class="text-gray-500 hover:text-gray-700">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div id="modalContent" class="p-4 max-h-96 overflow-y-auto">
        <!-- Photos will be inserted here -->
      </div>
    </div>
  </div>

  <!-- Cards Grid -->
  <main id="carsGrid" class="p-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 flex-grow" style="display:grid; grid-template-columns:repeat(auto-fit,minmax(320px,1fr)); gap:24px;">
    <h1 class="text-3xl font-bold mb-6">Car Dashboard</h1>
    <div id="dashboardTabs" class="flex gap-4 mb-6">
      <button class="tabBtn bg-blue-100 px-4 py-2 rounded" data-tab="inprogress">In Progress</button>
      <button class="tabBtn bg-yellow-100 px-4 py-2 rounded" data-tab="received">Received</button>
      <button class="tabBtn bg-green-100 px-4 py-2 rounded" data-tab="completed">Completed (Not Paid)</button>
      <button class="tabBtn bg-gray-200 px-4 py-2 rounded" data-tab="archived">Archived</button>
    </div>
    <div id="dashboardCards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
    <table class="w-full text-left border">
      <thead>
        <tr>
          <th class="p-2 border">Username</th>
          <th class="p-2 border">Role</th>
          <th class="p-2 border">Change Role</th>
          <th class="p-2 border">Delete</th>
        </tr>
      </thead>
      <tbody id="usersTableBody"></tbody>
    </table>
    <span id="userMgmtStatus" class="text-green-600 text-sm"></span>
  </section>
    <!-- Cars will be inserted here -->
  </main>

  <!-- Footer -->
  <footer class="bg-gray-800 text-white p-4 text-center">
    Master Body Shop Â© 2025
  </footer>

  <script>
    // Show Admin Dashboard button only for admins
    async function showAdminDashBtn() {
      const res = await fetch('/api/me');
      if (res.ok) {
        const me = await res.json();
        if (me.role === 'admin') {
          document.getElementById('adminDashBtn').style.display = '';
        }
      }
    }
    showAdminDashBtn();
    // Show admin section if user is admin
    async function checkAdmin() {
      const res = await fetch('/api/me');
      if (res.ok) {
        const me = await res.json();
        if (me.role === 'admin') {
          document.getElementById('adminUserMgmt').style.display = '';
          fetchUsers();
        }
      }
    }

    async function fetchUsers() {
      const res = await fetch('/api/users');
      if (!res.ok) return;
      const users = await res.json();
  const tbody = document.getElementById('usersTableBody');
  if (!tbody) return;
  tbody.innerHTML = '';
      users.forEach(user => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="p-2 border">${user.Username}</td>
          <td class="p-2 border">${user.Role}</td>
          <td class="p-2 border">
            <select data-username="${user.Username}" class="roleSelect border rounded px-2 py-1">
              <option value="admin" ${user.Role === 'admin' ? 'selected' : ''}>Admin</option>
              <option value="technician" ${user.Role === 'technician' ? 'selected' : ''}>Technician</option>
            </select>
            <button data-username="${user.Username}" class="saveRoleBtn bg-blue-500 text-white px-2 py-1 rounded ml-2">Save</button>
          </td>
          <td class="p-2 border">
            <button data-username="${user.Username}" class="deleteUserBtn bg-red-500 text-white px-2 py-1 rounded">Delete</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
      // Add event listeners for role change and delete
      document.querySelectorAll('.saveRoleBtn').forEach(btn => {
        btn.onclick = async function() {
          const username = btn.getAttribute('data-username');
          const select = btn.parentElement.querySelector('.roleSelect');
          const role = select.value;
          const res = await fetch('/api/users/role', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, role })
          });
          document.getElementById('userMgmtStatus').textContent = await res.text();
          fetchUsers();
        };
      });
      document.querySelectorAll('.deleteUserBtn').forEach(btn => {
        btn.onclick = async function() {
          const username = btn.getAttribute('data-username');
          const res = await fetch('/api/users/delete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username })
          });
          document.getElementById('userMgmtStatus').textContent = await res.text();
          fetchUsers();
        };
      });
    }

    checkAdmin();
    document.getElementById('logoutBtn').addEventListener('click', async function() {
      await fetch('/logout', { method: 'POST' });
      window.location.href = '/';
    });
    let carsData = [];

    async function fetchCars() {
      const res = await fetch("/dashboard");
      const response = await res.json();
      carsData = Array.isArray(response) ? response : response.data || [];
      console.log(`[DEBUG] Cars received from backend:`, carsData.length, carsData);
      renderCards(carsData);
    }

    async function fetchCarPhotos(carId) {
      try {
        const res = await fetch(`/car/${carId}`);
        const carData = await res.json();
        return carData.photos || [];
      } catch (error) {
        console.error('Error fetching photos:', error);
        return [];
      }
    }

    function renderCards(cars) {
      const grid = document.getElementById("carsGrid");
      grid.innerHTML = "";

      if (cars.length === 0) {
        grid.innerHTML = '<div class="col-span-3 text-center py-10 text-gray-500">No cars found</div>';
        return;
      }

      cars.forEach((car, idx) => {
        console.log(`[DEBUG] Rendering car #${idx + 1}:`, car);
        const card = document.createElement("div");
        let statusColor = "bg-white";
        switch (car.WorkStatus) {
          case "Completed":
            statusColor = "bg-green-100";
            break;
          case "In Progress":
            statusColor = "bg-yellow-100";
            break;
          case "Waiting on Parts":
            statusColor = "bg-blue-100";
            break;
          case "Received":
            statusColor = "bg-gray-100";
            break;
        }
        card.className = `${statusColor} rounded-2xl shadow-lg p-5 flex flex-col gap-4 hover:shadow-2xl transition cursor-pointer`;
        card.onclick = () => {
          window.location.href = `/car-details.html?id=${car.Id}`;
        };

        // Photo section at top
        const photoSection = document.createElement("div");
        photoSection.className = "relative";

        // Main photo display
        const mainPhoto = document.createElement("div");
        mainPhoto.className = "w-full h-48 bg-gray-200 rounded-lg flex items-center justify-center overflow-hidden cursor-pointer relative";
        mainPhoto.setAttribute('data-car-id', car.Id);

        // Show preview image if available
        if (car.PhotoCount > 0) {
          // Use correct backend route for preview image
          mainPhoto.innerHTML = `
            <img src="/photo/car/${car.Id}" alt="Car Photo" class="w-full h-full object-cover" onerror="this.style.display='none';this.parentNode.querySelector('.fallback-photo').style.display='flex';">
            <div class="fallback-photo text-center text-gray-500 absolute inset-0 items-center justify-center hidden flex-col">
              <i class="fas fa-camera text-4xl mb-2"></i>
              <p>No preview available</p>
            </div>
            <div class="absolute bottom-2 right-2 bg-black bg-opacity-50 text-white text-xs px-2 py-1 rounded">
              ${car.PhotoCount} photo${car.PhotoCount > 1 ? 's' : ''}
            </div>
          `;
        } else {
          mainPhoto.innerHTML = `
            <div class="text-center text-gray-500">
              <i class="fas fa-camera text-4xl mb-2"></i>
              <p>No photos</p>
            </div>
          `;
        }

        photoSection.appendChild(mainPhoto);
        
        // Car info section
        const info = document.createElement("div");
        info.className = "flex-1";

        info.innerHTML = `
          <h2 class="text-lg font-bold mb-2">${car.Year || ''} ${car.Make || ''} ${car.Model || ''}</h2>
          <p><span class="font-semibold">Customer:</span> ${car.Customer || ''}</p>
          <p><span class="font-semibold">VIN:</span> ${car.VIN || 'N/A'}</p>
          <p class="flex items-center"><span class="font-semibold">Color:</span> 
            ${car.Color ? `
              <span class="ml-1 inline-flex items-center">
                <span class="inline-block w-4 h-4 rounded-full border mr-1" style="background:${car.Color.toLowerCase()}"></span>
                ${car.Color}
              </span>
            ` : 'N/A'}
          </p>
          <p><span class="font-semibold">Arrival:</span> ${new Date(car.ArrivalDate).toLocaleDateString()}</p>
          <div class="mt-3 grid grid-cols-2 gap-2">
            <div>
              <label class="font-semibold block text-sm">Status</label>
              <span class="block px-2 py-1 rounded w-full text-sm bg-gray-100">${car.WorkStatus || ''}</span>
            </div>
            <div>
              <label class="font-semibold block text-sm">Customer Phone</label>
              <span class="block px-2 py-1 rounded w-full text-sm bg-gray-100">${car.CustomerPhone || ''}</span>
            </div>
            <div>
              <label class="font-semibold block text-sm">Ready for Work</label>
              <span class="block px-2 py-1 rounded w-full text-sm bg-gray-100">${car.ReadyForWork || ''}</span>
            </div>
          </div>
        `;

        // Assemble card
        card.appendChild(photoSection);
        card.appendChild(info);
        grid.appendChild(card);

        // All event listeners for update, photo upload, and view photos have been removed for read-only display.
      });
        console.log('[DEBUG] grid.innerHTML after rendering:', grid.innerHTML);
    }

    // Close modal functionality
    document.getElementById('closeModal').addEventListener('click', () => {
      document.getElementById('photoModal').classList.add('hidden');
    });

    // Close modal when clicking outside
    document.getElementById('photoModal').addEventListener('click', (e) => {
      if (e.target.id === 'photoModal') {
        document.getElementById('photoModal').classList.add('hidden');
      }
    });

    // Search/filter
    function filterCars() {
      const query = document.getElementById("searchInput").value.toLowerCase();
      const status = document.getElementById("statusFilter").value;
      const make = document.getElementById("makeFilter").value.toLowerCase();
      const model = document.getElementById("modelFilter").value.toLowerCase();
      const ready = document.getElementById("readyFilter").checked;
      const paid = document.getElementById("paymentFilter").checked;
      const parts = document.getElementById("partsFilter").checked;

      console.log('[DEBUG] filterCars: carsData before filtering:', carsData.length, carsData);
      let filtered = carsData.filter(car => {
        let match = true;
        if (query) {
          match = match && (
            (car.Customer && car.Customer.toLowerCase().includes(query)) ||
            ((car.Make || '').toLowerCase().includes(query)) ||
            ((car.Model || '').toLowerCase().includes(query)) ||
            ((car.WorkStatus || '').toLowerCase().includes(query)) ||
            ((car.VIN || '').toLowerCase().includes(query))
          );
        }
        if (status) match = match && car.WorkStatus === status;
        if (make) match = match && (car.Make && car.Make.toLowerCase().includes(make));
        if (model) match = match && (car.Model && car.Model.toLowerCase().includes(model));
        if (ready) match = match && car.ReadyForWork === "Yes";
        if (paid) match = match && car.CustomerPayment;
        if (parts) match = match && car.PartsOrdered === "Yes";
        return match;
      });
      console.log('[DEBUG] filterCars: filtered after filtering:', filtered.length, filtered);
      renderCards(filtered);
    }

    document.getElementById("searchInput").addEventListener("input", filterCars);
    document.getElementById("statusFilter").addEventListener("change", filterCars);
    document.getElementById("makeFilter").addEventListener("input", filterCars);
    document.getElementById("modelFilter").addEventListener("input", filterCars);
    document.getElementById("readyFilter").addEventListener("change", filterCars);
    document.getElementById("paymentFilter").addEventListener("change", filterCars);
    document.getElementById("partsFilter").addEventListener("change", filterCars);

    // Initial fetch
    fetchCars();
  </script>
</body>
</html>